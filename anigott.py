import os
import re
import logging
import asyncio
from aiogram import Bot, Dispatcher, F
from aiogram.enums import ParseMode
from aiogram.filters import Command
from aiogram.types import Message
from aiogram.client.default import DefaultBotProperties

# —á–∏—Ç–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
API_TOKEN = os.getenv("API_TOKEN")

# –õ–æ–≥–∏
logging.basicConfig(level=logging.INFO)

# –ë–æ—Ç + –¥–∏—Å–ø–µ—Ç—á–µ—Ä
bot = Bot(
    token=API_TOKEN,
    default=DefaultBotProperties(parse_mode=ParseMode.HTML)
)
dp = Dispatcher()

# –¢–∞–±–ª–∏—Ü–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ —É —Ç–µ–±—è)
COEFFS = {
    "–î–µ–º–æ–Ω –ú–∏—Ü—É—Ä–∏": {80: 500},
    "–î–µ–º–æ–Ω –†–µ–Ω–≥–æ–∫—É": {80: 270},
    "–î–µ–º–æ–Ω –ú—É–∏—á–∏—Ä–æ": {80: 190},
    "–î–µ–º–æ–Ω –¢–µ–Ω–≥–µ–Ω": {80: 120},
    "–ì–µ—Å—Ç–∏—è": {80: 25},
    "–†–µ–±–µ–∫–∫–∞": {80: 25},
    "–Ø—Ç–æ": {80: 0.3},
    "–î–∂–∏–Ω": {80: 25},
    "–ò—Ä—É–º–∞": {87: 1},
    "–ê–∫—ç–Ω–æ": {88: 1},
    "–ö–∞—Ä–µ–Ω": {80: 20},
    "–°–°": {80: 1.5},
    "–ê—Å—É–Ω–∞": {80: 15},
    "–ê–ª—å–±–µ–¥–æ": {80: 15},
    "–ò–Ω–æ—Ä–∏": {80: 15},
    "–û—Ä–∫–±–æ–ª–≥": {86: 10},
    "–ë–µ–ª–ª": {86: 10},
    "–°–∞–∫–æ–º–æ—Ç–æ": {80: 8},
    "–•–∏–Ω–∞—Ç–∞": {80: 2},
    "–î–∞–∑–∞–π": {80: 2},
    "–ö–ª–µ–π–Ω": {80: 0.3},
    "–ö—É—Ä–∏—Å—É": {80: 0.3},
    "–ö–∏—Ä–∏—Ç–æ": {80: 0.3},
    "–ú–∞–∫–∏–º–∞": {80: 0.3},
    "–î–∂–æ—Ä–Ω–æ": {99: 0.25},
    "–•–∞—à–∏—Ä–∞–º–∞": {99: 0.25},
    "–ì–∞—Ä–ø": {88: 0.4},
    "–ì–æ–¥–∂–æ": {99: 0.5, 89: 3.5},
    "–ì–∞—Ç—Å": {88: 0.55},
    "–Æ–ª–∏—É—Å": {99: 0.55},
    "–ó–µ–≤—Å": {99: 0.55},
    "–ú–µ—Ä–ª–∏–Ω": {88: 0.65},
    "–ó–µ–Ω–æ": {88: 0.75},
    "–ö–∞–≥—É—è": {99: 0.75},
    "–ó–æ—Ä–æ": {88: 0.75},
    "–ê—Ä—Ç—É—Ä": {99: 0.75, 89: 27},
    "–í—Å–µ–º–æ–≥—É—à–∏–π": {99: 0.75},
    "–ö–∞–Ω–µ–∫–∏": {99: 0.85},
    "–ó–µ–ª–¥—Ä–∏—Å": {88: 0.85},
    "–ò—à—Ç–∞—Ä": {99: 1},
    "–ô–æ—à–∏–º—É—Ä–∞": {99: 1},
    "–ò—á–∏–±–µ–π": {88: 1},
    "–•–∞—à–≤–∞—å–ª—Ç": {88: 1.25},
    "–ë—ç–Ω–∏–º–∞—Ä—É": {88: 1.25, 89: 27},
    "–ü—É—á—á–∏": {88: 1.25},
    "–ö–∞—Ä—Å": {88: 1.25},
    "–§–∞–Ω–Ω–∏": {88: 1.5},
    "–°–∞—Å–∞–∫–∏": {88: 1.5},
    "–í–µ–ª—å–∑–µ–≤—É–ª": {88: 1.75},
    "–ù–∞—Ä—É—Ç–æ": {88: 2},
    "–ù–∞–æ—Ñ—É–º–∏": {99: 2},
    "–û—Ç—Ç–∞—Ä": {99: 2},
    "–Æ—Ä–∏": {88: 2.25},
    "–ò—Ç–∞—á–∏": {88: 2.25},
    "–ö–∞–º–∏—à": {88: 2.25},
    "–ö–∞—à–∏–º–æ": {88: 2.5},
    "–¢–∞—Ü—É–º–∏": {88: 2.5},
    "–õ–∞–∫—Å—É—Å": {88: 2.5},
    "–ë–µ–ª–∏–æ–Ω": {88: 2.5},
    "–û—Ä—Å—Ç–µ–¥": {99: 2.75},
    "–ö—å–µ—Ä–∞–∫—É": {88: 2.75},
    "–ú–∏–¥–æ—Ä–∏—è": {88: 2.75},
    "–¢–∞–Ω–¥–∂–∏—Ä–æ": {99: 2.75},
    "–ö–µ–Ω–ø–∞—á–∏": {99: 2.75},
    "–ú–µ—Ä–µ–ª–µ–æ–Ω–∞": {88: 2.75},
    "–§–æ–Ω–∏—É—Å": {88: 2.75},
    "–í–µ–∫—Ç–æ—Ä": {99: 2.75},
    "–ü–∞—É—ç—Ä": {88: 2.75},
    "–ê–¥–∞–º": {99: 3.5, 90: 45},
    "–¢–æ—Ä—É": {99: 3},
    "–£—Ä–µ–∫": {99: 3},
    "–ü–æ—á–∏—Ç–∞": {99: 3},
    "–ë–µ–Ω–∑–æ–ø–∏–ª–∞": {99: 3},
    "–ö—Ä–æ–∫–æ–¥–∞–π–ª": {88: 3},
    "–ì—Ä—ç–π": {88: 3.25},
    "–î—ç–Ω–¥–∂–∏": {88: 3.25},
    "–≠—à–±–æ—Ä–Ω": {99: 3.5},
    "–î–∂–æ–Ω": {99: 3.5},
    "–ü–∞–∫": {88: 4},
    "–§–∏–Ω–Ω": {88: 4.5},
    "–ê—Ä–ª–µ–∫–∏–Ω": {89: 4.5},
    "–ë–µ–ª–ª": {88: 4.5},
    "–†–∞–π–Ω—Ö–∞—Ä–¥": {99: 4.5},
    "–®–∏–Ω–∏–≥–∞–º–∏": {99: 5},
    "–ó–µ—Ä–∏": {99: 5},
    "–®–æ": {88: 6},
    "–ú–∞—Ä—ç": {88: 6},
    "–ë–ª—ç–∫": {88: 6},
    "–ö–∏–¥": {88: 6},
    "–•–∞—É–º–µ—è": {99: 6},
    "–Ø–º–∞–º–æ—Ç–æ": {89: 7},
    "–ê–π–∑": {88: 7},
    "–î–æ—É–º–∞": {88: 7, 89: 11},
    "–ò–∑–∞–Ω–≤–º–∏": {99: 9},
    "–¶—É–∫–∏—ë–º–∏": {99: 9},
    "–õ—é—Ü–∏—Ñ–µ—Ä–æ": {89: 9},
    "–ú—É–¥–∑–∞–Ω": {89: 9},
    "–ê—Ä–¥–∂—É–Ω–∞": {99: 10},
    "–ê–Ω—Ç–∞—Ä—ç—Å": {89: 10},
    "–†–∏–∑–µ": {89: 10},
    "–§–µ—Ä–Ω": {88: 11},
    "–ö–æ–∫—É—à–∏–±–æ": {89: 11},
    "–ê—Ä–∏–º–∞": {89: 11},
    "–ú–µ–≥—É–º–∏–Ω": {88: 12},
    "–≠—Ä–∑–∞": {88: 12},
    "–≠—Ä–∏—Å": {88: 12},
    "–ê–∫–≤–∞": {88: 12},
    "–ë–∞–∞–º": {89: 12},
    "–ì–∏–ª—å–≥–∞–º–µ—à": {89: 12},
    "–ë–∏—à–∞–º–æ–Ω": {89: 12},
    "–ê–≤—Ä–æ—Ä–∞": {99: 14},
    "–®–∞–ª—Ç–∏—Ä": {99: 14},
    "–≠—Å–¥–µ—Å": {99: 14, 90: 550},
    "–î–∏–∞–±–ª–æ": {89: 14},
    "–®–∏–≥–∞": {89: 14},
    "–≠–Ω–∫–∏–¥—É": {88: 15},
    "–Ø—Ö–≤–µ": {100: 15},
    "–°–∞–π—Ç–∞–º–∞": {100: 15},
    "–î–∂–æ–Ω–Ω–∏": {89: 16},
    "–ó–µ—Ä–µ—Ñ": {89: 16.5},
    "–®–∞–Ω–∫—Å": {89: 16.5},
    "–°—É–∫—É–Ω–∞": {99: 0.55, 100: 17},
    "–î—ç–≤–∏–¥": {89: 19},
    "–ê–∫—Ç—ë—Ä": {89: 19},
    "–ö—É—Ä—É–º–∏": {80: 20},
    "–ê—Ä—Ç—É—Ä–∏—è": {100: 80, 88: 22},
    "–®–∏–Ω—Ä–∞": {100: 23},
    "–¢–∏–∞–º–∞—Ç": {99: 25},
    "–Ø—Ç–æ": {80: 0.3, 89: 25},
    "–ê–∫–∞–º–µ": {89: 27},
    "–ú–∞–∫–∞": {89: 27},
    "–§—Ä–µ—è": {89: 27},
    "–†–∏–º—É—Ä—É": {100: 27},
    "–ê–∫–Ω–æ–ª–æ–≥–∏—è": {100: 27},
    "–ê–ª—å—Ñ–∞": {89: 28},
    "–†–∞—Ñ—Ç–∞–ª–∏—è": {89: 30},
    "–§—Ä–∏—Ä–µ–Ω": {89: 30},
    "–õ—É—Ñ—Ñ–∏": {100: 30},
    "–í–∏–∑": {89: 35},
    "–°–∞—Ç–µ–ª–ª–∞": {89: 35},
    "–•–∞—Å—Å–∞–Ω": {89: 40},
    "–¢–∞—á–º–∏": {100: 40},
    "–û–ª—å–≥–∞": {89: 50},
    "–î–∏–æ": {100: 50},
    "–ú–∞—Ö–æ—Ä–∞–≥–∞": {90: 55},
    "–õ—é—Ü–∏—É—Å": {100: 60},
    "–ú–∞–¥–∞—Ä–∞": {90: 70},
    "–ö–∏—Ä–∏—Ç–æ": {90: 100},
    "–Å—Ä–∏—á–∏": {90: 120},
    "–†—É–¥–µ—É—Å": {90: 135},
    "–ê–∏–Ω–∑": {90: 190},
    "–ú–∞–∫–∏–º–∞": {90: 240},
    "–ê–π–∑–µ–Ω": {90: 280},
    "–°–∏–¥": {90: 315},
    "–°–æ–ª–æ–º–æ–Ω": {90: 330},
    "–ö–∞—Ä—Ç–∞": {80: 0.1, 87: 0.25},
    "–æ–±–ª –°–∏–¥": {90: 140},
    "–æ–±–ª –ú–∞–∫–∏–º–∞": {90: 130},
    "–æ–±–ª –°—É–±–∞—Ä—É": {80: 130},
    "–æ–±–ª –ê–π–∑–µ–Ω": {90: 60},
    "–æ–±–ª –î–∞—Ä–∫–Ω–µ—Å—Å": {80: 40},
    "–æ–±–ª –î–µ—Å–≥–∞–Ω": {80: 40},
    "–æ–±–ª –õ—é—Å–∏üíß": {80: 40},
    "–æ–±–ª –ê–ª—å–±–µ–¥–æ": {88: 30},
    "–æ–±–ª –†—É–¥–µ—É—Å": {90: 30},
    "–æ–±–ª –í–∏–∑": {89: 30},
    "–æ–±–ª –ï—Ä–∏–∏—á–∏": {90: 30},
    "–æ–±–ª –†—ç–º": {80: 25},
    "–æ–±–ª –°—Ç–∞—Ä–∫": {80: 20},
    "–æ–±–ª –•–∏–Ω–∞—Ç–∞": {80: 20},
    "–æ–±–ª –†–∏–∑–µ": {80: 20},
    "–æ–±–ª –¢–µ–Ω–≥–µ–Ω": {80: 20},
    "–æ–±–ª –ù–µ–ª–ª": {80: 20},
    "–æ–±–ª –ü–∞—É—ç—Ä": {80: 20},
    "–æ–±–ª –ê—Å—É–Ω–∞": {80: 18},
    "–æ–±–ª –õ—é—Å–∏‚ö°Ô∏è": {80: 18},
    "–æ–±–ª –°–∏–ª—å—Ñ–∏–µ—Ç—Ç–∞": {80: 18},
    "–æ–±–ª –≠–¥–≤–µ—Ä–¥": {84: 18},
    "–æ–±–ª –§—Ä–∏—Ä–µ–Ω": {89: 17},
    "–æ–±–ª –†–∞—Ñ—Ç–∞–ª–∏—è": {89: 17}, 
    "–æ–±–ª –ê–ª—å—Ñ–∞": {89: 17}, 
    "–æ–±–ª –î–∏–∞–±–ª–æ": {89: 17}, 
    "–æ–±–ª –ú—É–¥–∑–∞–Ω": {89: 17},
    "–æ–±–ª –Æ–∫–∏–º–µ": {80: 15}, 
    "–æ–±–ª –ì—Ä–∏–º–¥–∂–æ—É": {80: 15}, 
    "–æ–±–ª –ú–∞–¥–∞—Ä–∞": {90: 15}, 
    "–æ–±–ª –ê—Ä–∏–º–∞": {89: 15}, 
    "–æ–±–ª –ò–≥—Ä–∏—Å": {80: 15}, 
    "–æ–±–ª –ì–∏–ª—å–≥–∞–º–µ—à": {89: 15}, 
    "–æ–±–ª –ö–∏—Ä–∏—Ç–æ": {90: 14}, 
    "–æ–±–ª –ê–¥–∞–º": {90: 14}, 
    "–æ–±–ª –ñ–¥–∏—Ä–∞–π—è": {80: 14}, 
    "–æ–±–ª –®–∏–≥–∞—Ä–∞–∫–∏": {89: 13}, 
    "–æ–±–ª –õ—É—Ñ—Ñ–∏": {100: 12}, 
    "–æ–±–ª –ì–∞—Ç—Å": {84: 12},
    "–æ–±–ª –ò—Ç–∞—á–∏": {80: 11}, 
    "–æ–±–ª –ö–∏–ª–ª—É–∞": {80: 10}, 
    "–æ–±–ª –†–æ–∫—Å–∏": {80: 10}, 
    "–æ–±–ª –ß–æ—Å–æ": {80: 10}, 
    "–æ–±–ª –†–∏–º—É—Ä—É": {100: 10}, 
    "–æ–±–ª –•—ç –∏–Ω –∏ –¥–∂–∏–Ω –≤—É": {82: 10}, 
    "–æ–±–ª –ù–∞–º–∏": {80: 10}, 
    "–æ–±–ª –®–∏–≥—ç–æ": {85: 10}, 
    "–æ–±–ª –†—É–∫–∏—è": {80: 10}, 
    "–æ–±–ª –ú–∏—Ü—É—Ä–∏": {80: 10},
    "–æ–±–ª –†–æ—Ä–∏": {83: 9}, 
    "–æ–±–ª –•–∞–æ": {85: 8}, 
    "–æ–±–ª –ê–ª—É–∫–∞—Ä–¥": {84: 8}, 
    "–æ–±–ª –§—Ä–∏—Ä–µ–Ω –∏ –•–∏–º–µ–ª—å": {82: 8}, 
    "–æ–±–ª –ú—ç—à": {84: 8}, 
    "–æ–±–ª –°–∞–π—Ç–∞–º–∞": {100: 7}, 
    "–æ–±–ª –°—É–∫—É–Ω–∞": {100: 7}, 
    "–æ–±–ª –£–ª—å–∫–∏–æ—Ä—Ä–∞": {80: 7}, 
    "–æ–±–ª –î–∂–∏–Ω –≤—É": {85: 6}, 
    "–æ–±–ª –ú–∞–º–æ—Ä—É –∏ –£—Å–∞–≥–∏": {82: 6}, 
    "–æ–±–ª –†–∏–Ω": {84: 5}, 
    "–æ–±–ª –ì–æ–¥–∂–æ": {89: 5}, 
    "–æ–±–ª –í–∞—Å–Ω–µ—Å—Å–∞": {80: 4.5}, 
    "–æ–±–ª –ù–∞–≥–∞—Ç–æ": {80: 4.5}, 
    "–æ–±–ª –ö–µ–Ω": {84: 4.5}, 
    "–æ–±–ª –®–∏–Ω—Ä–∞": {84: 4},
    "–æ–±–ª –ê–∫–∞–º–µ": {83: 3}, 
    "–æ–±–ª –ì–∞—Ä–æ—É": {98: 3}, 
    "–æ–±–ª –ò—á–∏–≥–æ": {98: 3}, 
    "–æ–±–ª –ò—Ç–∞–¥–æ—Ä–∏": {83: 3}, 
    "–æ–±–ª –ù–µ–∑—É–∫–æ": {79: 3}, 
    "–æ–±–ª –Ø—Ö–≤–µ": {100: 3}, 
    "–æ–±–ª –ó–æ—Ä–æ": {80: 3}, 
    "–æ–±–ª –ù–∞—Ä—É—Ç–æ": {98: 2}, 
    "–æ–±–ª –®–∏–Ω–æ–±—É": {79: 1.5},
    "—Ä—É–±–∏–Ω –î–∞–∑–∞–π": {80: 15},
    "—Ä—É–±–∏–Ω –ï—Ä–∏–∏—á–∏": {90: 5},
    "—Ä—É–±–∏–Ω –ö—É—Ä–∞–ø–∏–∫–∞": {80: 5},
    "—Ä—É–±–∏–Ω –ò—Ç–∞—á–∏": {80: 5},
    "—Ä—É–±–∏–Ω –£–ª—å–∫–∏–æ—Ä–∞": {80: 5},
    "—Ä—É–±–∏–Ω –ì–∞—Ç—Å": {88: 2},
    "—Ä—É–±–∏–Ω –°–∞–Ω–µ–º–∏": {87: 2},
    "—Ä—É–±–∏–Ω –ó–µ–Ω–∏—Ü—É": {86: 2},
}

# --- –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è ---
def normalize_coeffs(raw):
    norm = {}
    for name, ratings in raw.items():
        key = name.strip().lower()
        bucket = {}
        for k, v in ratings.items():
            try:
                bucket[int(k)] = float(v)
            except Exception:
                continue
        norm[key] = bucket
    return norm

COEFFS_NORM = normalize_coeffs(COEFFS)


# --- /start ---
@dp.message(Command("start"))
async def start_command(message: Message):
    await message.answer(
        f"–ü—Ä–∏–≤–µ—Ç, <b>{message.from_user.first_name}</b>!\n"
        f"–ß—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞–≤–∫—É, –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç:\n"
        f"<code>–°—Ç–∞–≤–∫–∞\n–ò–º—è–ö–∞—Ä—Ç—ã –£—Ä–æ–≤–µ–Ω—å –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</code>\n\n"
        f"–ü—Ä–∏–º–µ—Ä:\n<code>–°—Ç–∞–≤–∫–∞\n–°—É–∫—É–Ω–∞ 100 \n–Ø—Ç–æ 80 2</code>"
    )


# --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞–≤–æ–∫ ---
@dp.message(F.text.startswith("–°—Ç–∞–≤–∫–∞"))
async def handle_bet(message: Message):
    lines = message.text.split("\n")[1:]  # —É–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É "–°—Ç–∞–≤–∫–∞"
    total_points = 0.0
    results = []

    pattern = re.compile(r'^\s*(.+?)\s+(\d{1,3})(?:\s+(\d+))?\s*$')

    for line in lines:
        if not line.strip():
            continue
        m = pattern.match(line)
        if not m:
            continue

        raw_name, num_str, count_str = m.groups()
        name_key = raw_name.strip().lower()
        number = int(num_str)
        count = int(count_str) if count_str else 1

        if name_key in COEFFS_NORM:
            if number in COEFFS_NORM[name_key]:
                coeff = COEFFS_NORM[name_key][number]
                points = coeff * count
                total_points += points
                nice_points = ('{:.2f}'.format(points)).rstrip('0').rstrip('.')
                results.append(f"{raw_name.strip()} {number} √ó{count} = {nice_points} –ø—Ç")
            else:
                available = ", ".join(str(n) for n in sorted(COEFFS_NORM[name_key].keys()))
                results.append(f"{raw_name.strip()} {number} ‚ùå –ù–µ—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ (–¥–æ—Å—Ç—É–ø–Ω—ã: {available})")
        else:
            results.append(f"{raw_name.strip()} {number} ‚ùå –¢–∞–∫–æ–π –∫–∞—Ä—Ç—ã –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ")

    reply_text = "–°—Ç–∞–≤–∫–∞\n" + "\n".join(results)
    username = f"@{message.from_user.username}" if message.from_user.username else message.from_user.first_name
    nice_total = ('{:.2f}'.format(total_points)).rstrip('0').rstrip('.')
    reply_text += f"\n\nüí∞ –ò—Ç–æ–≥ {username}: {nice_total} –ø—Ç"

    await message.answer(reply_text)


# --- –∑–∞–ø—É—Å–∫ ---
async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
